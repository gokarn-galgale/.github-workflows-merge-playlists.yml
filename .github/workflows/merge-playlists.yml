python3 - <<EOF
          import re
          import os

          # 1. Priorities
          marathi_targets = ["Zee Marathi", "Zee Marathi HD", "Star Pravah", "Star Pravah HD", "Colors Marathi", "Colors Marathi HD", "Sony Marathi", "Zee Yuva", "Sun Marathi", "DD Sahyadri", "Fakt Marathi", "Zee Talkies", "Zee Talkies HD", "Pravah Picture", "Pravah Picture HD", "Shemaroo Marathibana", "Zee Chitramandir", "Zee 24 Taas", "ABP Majha", "News18 Lokmat", "NDTV Marathi", "TV9 Marathi", "Saam TV", "Jai Maharashtra", "Lokshahi", "Pudhari News", "9X Jhakaas", "Maiboli", "Sangeet Marathi", "Dagdusheth Ganpati (Live)", "Vitthal Rukmini (Live)", "Tulja Bhavani (Live)", "Mahalaxmi Mumbai (Live)", "MKN Marathi", "News State Maharashtra-Goa"]
          
          # Only keep these main sources
          allowed_sources = ["tataplay", "runntv", "lg movies", "waves ott", "jiotv"]
          
          if not os.path.exists("raw_pool.m3u"):
              exit(1)

          with open("raw_pool.m3u", "r", encoding="utf-8", errors="ignore") as f:
              content = f.read()

          blocks = re.split(r'(?=#EXTINF)', content)
          
          # Dictionary to hold categories: { "Category Name": [List of Channel Blocks] }
          category_map = {}
          seen_names = set()

          for block in blocks:
              block = block.strip()
              if not block or "#EXTM3U" in block: continue
              
              header = block.split('\n')[0]
              name_match = re.search(r',([^,]*)$', header)
              group_match = re.search(r'group-title="([^"]*)"', header, re.IGNORECASE)
              
              name = name_match.group(1).strip() if name_match else "Unknown"
              raw_group = group_match.group(1) if group_match else "General"
              
              # Filter by allowed sources
              if not any(k in raw_group.lower() for k in allowed_sources) and "jiotv+" not in raw_group.lower():
                  continue

              # Deduplication (Keep best/first found)
              if name.lower() in seen_names: continue
              seen_names.add(name.lower())

              # Clean Category Name (Remove Emojis and Prefixes)
              clean_pattern = r'^(?:JioTv|Tataplay|RunnTV|Waves|LG).*?[ðŸ“ºâž•ðŸŽ­ðŸƒðŸŽ¬]\s*(.*)'
              match = re.match(clean_pattern, raw_group, re.IGNORECASE)
              new_group = match.group(1).strip().capitalize() if match else raw_group.capitalize()

              # Priority Logic: Override for Marathi
              if name in marathi_targets:
                  new_group = "Marathi"

              # Append to Category Map
              if new_group not in category_map:
                  category_map[new_group] = []
              
              # Update the block with the new group name and source tag
              updated_block = re.sub(r'group-title="[^"]*"', f'group-title="{new_group}"', block)
              category_map[new_group].append(updated_block)

          # Write Final Sorted File
          with open("merged_playlist.m3u", "a", encoding="utf-8") as out:
              # First, write Marathi (if exists)
              if "Marathi" in category_map:
                  out.write("\n## --- MARATHI --- ##\n")
                  category_map["Marathi"].sort(key=lambda x: x.split(",")[-1].strip().lower())
                  out.write("\n".join(category_map["Marathi"]) + "\n")
                  del category_map["Marathi"]
              
              # Then, write all other categories alphabetically
              for cat in sorted(category_map.keys()):
                  out.write(f"\n## --- {cat.upper()} --- ##\n")
                  # Sort channels within the category alphabetically
                  category_map[cat].sort(key=lambda x: x.split(",")[-1].strip().lower())
                  out.write("\n".join(category_map[cat]) + "\n")
          EOF

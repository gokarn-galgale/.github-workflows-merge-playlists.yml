name: Merge M3U Playlists
on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

jobs:
  merge-job:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout your repo
        uses: actions/checkout@v4

      - name: Fetch and Merge Playlists
        run: |
          # 1. Start with Header and Multi-EPG
          echo '#EXTM3U x-tvg-url="https://avkb.short.gy/tsepg.xml.gz,https://raw.githubusercontent.com/dgr8akki/EPG/main/epg.xml.gz"' > merged_playlist.m3u
          
          # 2. Pool all raw data (Order matters: jtv is 1, z5 is 2, stream is 3)
          curl -s https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/jtv.m3u | grep -v "#EXTM3U" >> raw_pool.m3u
          curl -s https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/z5.m3u | grep -v "#EXTM3U" >> raw_pool.m3u
          curl -s https://raw.githubusercontent.com/vaathala00/sl/refs/heads/main/stream.m3u | grep -v "#EXTM3U" >> raw_pool.m3u

          # 3. Precise Extraction using Python (With Priority & Deduplication)
          echo "## --- MARATHI --- ##" >> merged_playlist.m3u
          
          python3 - <<EOF
          import re
          
          target_channels = ["Zee Marathi", "Zee Marathi HD", "Star Pravah", "Star Pravah HD", "Colors Marathi", "Colors Marathi HD", "Sony Marathi", "Zee Yuva", "Sun Marathi", "DD Sahyadri", "Fakt Marathi", "Zee Talkies", "Zee Talkies HD", "Pravah Picture", "Pravah Picture HD", "Shemaroo Marathibana", "Zee Chitramandir", "Zee 24 Taas", "ABP Majha", "News18 Lokmat", "NDTV Marathi", "TV9 Marathi", "Saam TV", "Jai Maharashtra", "Lokshahi", "Pudhari News", "9X Jhakaas", "Maiboli", "Sangeet Marathi", "Dagdusheth Ganpati (Live)", "Vitthal Rukmini (Live)", "Tulja Bhavani (Live)", "Mahalaxmi Mumbai (Live)", "MKN Marathi", "News State Maharashtra-Goa"]
          
          with open("raw_pool.m3u", "r") as f:
              content = f.read()

          blocks = re.split(r'(?=#EXTINF)', content)
          
          marathi_blocks = []
          seen_channels = set()  # This tracks channels already added
          
          for block in blocks:
              if not block.strip(): continue
              lines = block.strip().split('\n')
              header_line = lines[0]
              
              match = re.search(r',([^,]*)$', header_line)
              if match:
                  found_name = match.group(1).strip()
                  name_lower = found_name.lower()
                  
                  # Check if it's a target channel AND hasn't been added yet
                  if any(target.lower() == name_lower for target in target_channels):
                      if name_lower not in seen_channels:
                          clean_lines = [l for l in lines if l.strip() != "--"]
                          marathi_blocks.append("\n".join(clean_lines))
                          seen_channels.add(name_lower) # Mark as added
          
          # Alphabetical Sorting
          marathi_blocks.sort(key=lambda x: x.split(",")[-1].strip().lower())
          
          with open("marathi_temp.m3u", "w") as out:
              out.write("\n".join(marathi_blocks) + "\n")
          EOF

          # 4. Finalize the Marathi category
          sed -i 's/group-title="[^"]*"/group-title="Marathi"/g' marathi_temp.m3u
          cat marathi_temp.m3u >> merged_playlist.m3u

          # 5. Add everything else
          echo "## --- OTHERS --- ##" >> merged_playlist.m3u
          cat raw_pool.m3u >> merged_playlist.m3u

      - name: Cleanup and Commit
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          sed -i '/^$/d' merged_playlist.m3u
          rm -f raw_pool.m3u marathi_temp.m3u
          git add merged_playlist.m3u
          git commit -m "Auto-refresh (30m): Fixed deduplication & priority" || exit 0
          git push


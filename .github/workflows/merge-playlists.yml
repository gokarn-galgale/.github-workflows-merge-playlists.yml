name: Merge JokerTV
on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  merge-job:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout your repo
        uses: actions/checkout@v4

      - name: Fetch JokerTV Data
        run: |
          # 1. Start Header
          echo '#EXTM3U x-tvg-url="https://avkb.short.gy/tsepg.xml.gz,https://raw.githubusercontent.com/dgr8akki/EPG/main/epg.xml.gz"' > merged_playlist.m3u
          
          # 2. Use WGET with Redirect Following and TiviMate User-Agent
          # This forces the server to see you as a TV App, not a browser/bot
          wget --max-redirect=20 \
               --user-agent="TiviMate/4.7.0 (NVIDIA SHIELD TV Pro; Android 11)" \
               --timeout=60 \
               --tries=5 \
               "https://joker-verse.vercel.app/jokertv/playlist.m3u?uid=690576414&pass=53f21a7c&vod=true" \
               -O raw_pool.m3u || echo "Download failed"

          # 3. Validation Check
          if [[ ! -s raw_pool.m3u ]]; then
            echo "ERROR: Data not received. The server redirected to Telegram or blocked the request."
            exit 1
          fi

          # 4. Check if the file actually contains M3U data or just HTML (Telegram Page)
          if grep -q "<!DOCTYPE html>" raw_pool.m3u; then
            echo "ERROR: The server sent a Web Page (Telegram redirect) instead of a Playlist."
            exit 1
          fi

      - name: Process Marathi Category
        run: |
          python3 - <<EOF
          import re
          import os

          targets = ["Zee Marathi", "Zee Marathi HD", "Star Pravah", "Star Pravah HD", "Colors Marathi", "Colors Marathi HD", "Sony Marathi", "Zee Yuva", "Sun Marathi", "DD Sahyadri", "Fakt Marathi", "Zee Talkies", "Zee Talkies HD", "Pravah Picture", "Pravah Picture HD", "Shemaroo Marathibana", "Zee Chitramandir", "Zee 24 Taas", "ABP Majha", "News18 Lokmat", "NDTV Marathi", "TV9 Marathi", "Saam TV", "Jai Maharashtra", "Lokshahi", "Pudhari News", "9X Jhakaas", "Maiboli", "Sangeet Marathi", "Dagdusheth Ganpati (Live)", "Vitthal Rukmini (Live)", "Tulja Bhavani (Live)", "Mahalaxmi Mumbai (Live)", "MKN Marathi", "News State Maharashtra-Goa"]
          
          if not os.path.exists("raw_pool.m3u"):
              exit(1)

          with open("raw_pool.m3u", "r", encoding="utf-8", errors="ignore") as f:
              content = f.read()

          blocks = re.split(r'(?=#EXTINF)', content)
          marathi_list = []
          other_list = []

          for block in blocks:
              block = block.strip()
              if not block or "#EXTM3U" in block: continue
              
              lines = block.split('\n')
              header = lines[0]
              
              name_match = re.search(r',([^,]*)$', header)
              if name_match:
                  c_name = name_match.group(1).strip()
                  if any(t.lower() == c_name.lower() for t in targets):
                      block = re.sub(r'group-title="[^"]*"', 'group-title="Marathi"', block)
                      marathi_list.append(block)
                  else:
                      other_list.append(block)

          marathi_list.sort(key=lambda x: x.split(",")[-1].strip().lower())

          with open("merged_playlist.m3u", "a", encoding="utf-8") as out:
              if marathi_list:
                  out.write("\n## --- MARATHI --- ##\n" + "\n".join(marathi_list) + "\n")
              if other_list:
                  out.write("\n## --- OTHERS --- ##\n" + "\n".join(other_list) + "\n")
          EOF

      - name: Push to Repo
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          sed -i '/^$/d' merged_playlist.m3u
          git add merged_playlist.m3u
          git commit -m "Bypassed Redirect - Updated JokerTV" || exit 0
          git push

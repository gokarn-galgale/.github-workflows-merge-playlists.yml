name: Merge M3U Playlists
on:
  schedule:
    - cron: '0 */1 * * *' # Runs every 6 hours
  workflow_dispatch:      # Allows you to run it manually

jobs:
  merge-job:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout your repo
        uses: actions/checkout@v4

      - name: Fetch and Merge Playlists
        run: |
          # 1. Start with the M3U Header
          echo "#EXTM3U" > merged_playlist.m3u
          
          # 2. Add jtv (Remove headers)
          curl -s https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/jtv.m3u | grep -v "^#EXTM3U" >> merged_playlist.m3u
          
          # 3. Add z5 (Remove headers)
          curl -s https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/z5.m3u | grep -v "^#EXTM3U" >> merged_playlist.m3u

          # 4. Add Sony Stream (Remove headers)
          curl -s https://raw.githubusercontent.com/vaathala00/sl/refs/heads/main/stream.m3u | grep -v "^#EXTM3U" >> merged_playlist.m3u

          # 5. Convert JSON to M3U (Updated for Name, Image, and Stream keys)
          curl -s https://raw.githubusercontent.com/DebugDyno/yo_events/4a8ac953d5db100864bd91afd12afda8f7e33f62/sony_livetv.json | \
          jq -r '.data[] | "#EXTINF:-1 tvg-logo=\"\(.image)\" group-title=\"\(.group)\", \(.name)\n\(.stream)"' >> merged_playlist.m3u

      - name: Cleanup and Commit
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          # Remove blank lines and fix any Windows-style line endings
          sed -i '/^$/d' merged_playlist.m3u
          
          git add merged_playlist.m3u
          git commit -m "Auto-update: All sources merged including Sony JSON" || exit 0
          git push


name: Merge M3U Playlists
on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  merge-job:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout your repo
        uses: actions/checkout@v4

      - name: Fetch and Merge Playlists
        run: |
          # 1. Start with Header and Multi-EPG
          echo '#EXTM3U x-tvg-url="https://avkb.short.gy/tsepg.xml.gz,https://raw.githubusercontent.com/dgr8akki/EPG/main/epg.xml.gz"' > merged_playlist.m3u
          
          # 2. Pool raw data (Priority Order: 1. JokerTV, 2. JTV, 3. Z5, 4. Stream)
          # Using quotes around URLs to prevent shell errors with '&'
          curl -sL "https://joker-verse.vercel.app/jokertv/playlist.m3u?uid=690576414&pass=53f21a7c&vod=true" | grep -v "#EXTM3U" >> raw_pool.m3u
          curl -sL "https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/jtv.m3u" | grep -v "#EXTM3U" >> raw_pool.m3u
          curl -sL "https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/z5.m3u" | grep -v "#EXTM3U" >> raw_pool.m3u
          curl -sL "https://raw.githubusercontent.com/vaathala00/sl/refs/heads/main/stream.m3u" | grep -v "#EXTM3U" >> raw_pool.m3u

          # 3. Global Deduplication and Marathi Categorization
          python3 - <<EOF
          import re
          import os

          target_marathi = ["Zee Marathi", "Zee Marathi HD", "Star Pravah", "Star Pravah HD", "Colors Marathi", "Colors Marathi HD", "Sony Marathi", "Zee Yuva", "Sun Marathi", "DD Sahyadri", "Fakt Marathi", "Zee Talkies", "Zee Talkies HD", "Pravah Picture", "Pravah Picture HD", "Shemaroo Marathibana", "Zee Chitramandir", "Zee 24 Taas", "ABP Majha", "News18 Lokmat", "NDTV Marathi", "TV9 Marathi", "Saam TV", "Jai Maharashtra", "Lokshahi", "Pudhari News", "9X Jhakaas", "Maiboli", "Sangeet Marathi", "Dagdusheth Ganpati (Live)", "Vitthal Rukmini (Live)", "Tulja Bhavani (Live)", "Mahalaxmi Mumbai (Live)", "MKN Marathi", "News State Maharashtra-Goa"]
          
          if not os.path.exists("raw_pool.m3u"):
              print("No data fetched")
              exit(0)

          with open("raw_pool.m3u", "r", encoding="utf-8", errors="ignore") as f:
              content = f.read()

          blocks = re.split(r'(?=#EXTINF)', content)
          
          seen_names = set()
          marathi_blocks = []
          other_blocks = []

          for block in blocks:
              block = block.strip()
              if not block: continue
              
              lines = block.split('\n')
              header = lines[0]
              
              # Name extraction
              name_match = re.search(r',([^,]*)$', header)
              if name_match:
                  channel_name = name_match.group(1).strip()
                  name_key = channel_name.lower()

                  if name_key in seen_names:
                      continue
                  seen_names.add(name_key)

                  # Cleanup block lines
                  clean_lines = [l for l in lines if l.strip() not in ["--", ""]]
                  clean_block = "\n".join(clean_lines)
                  
                  # Check for Marathi targets (case-insensitive)
                  is_marathi = False
                  for m in target_marathi:
                      if m.lower() == name_key:
                          is_marathi = True
                          break
                  
                  if is_marathi:
                      # Replace original group with Marathi
                      mod_block = re.sub(r'group-title="[^"]*"', 'group-title="Marathi"', clean_block)
                      marathi_blocks.append(mod_block)
                  else:
                      other_blocks.append(clean_block)

          # Sort Marathi
          marathi_blocks.sort(key=lambda x: x.split(",")[-1].strip().lower())

          # Write Final
          with open("merged_playlist.m3u", "a", encoding="utf-8") as out:
              out.write("\n## --- MARATHI --- ##\n")
              out.write("\n".join(marathi_blocks) + "\n")
              out.write("\n## --- OTHERS --- ##\n")
              out.write("\n".join(other_blocks) + "\n")
          EOF

      - name: Cleanup and Commit
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Cleanup empty lines
          sed -i '/^$/d' merged_playlist.m3u
          rm -f raw_pool.m3u
          
          git add merged_playlist.m3u
          git commit -m "Auto-refresh: Fixed Python exit code 1 error" || exit 0
          git push

name: Merge JokerTV Specific
on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  merge-job:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch JokerTV
        run: |
          echo '#EXTM3U x-tvg-url="https://avkb.short.gy/tsepg.xml.gz,https://raw.githubusercontent.com/dgr8akki/EPG/main/epg.xml.gz"' > merged_playlist.m3u
          wget --max-redirect=20 \
               --user-agent="TiviMate/4.7.1 (NVIDIA SHIELD TV Pro; Android 11)" \
               --timeout=60 --tries=5 \
               "https://joker-verse.vercel.app/jokertv/playlist.m3u?uid=690576414&pass=53f21a7c&vod=true" \
               -O raw_pool.m3u

      - name: Process Merge and Catchup
        run: |
          python3 - <<EOF
          import re
          import os

          marathi_targets = ["Zee Marathi", "Zee Marathi HD", "Star Pravah", "Star Pravah HD", "Colors Marathi", "Colors Marathi HD", "Sony Marathi", "Zee Yuva", "Sun Marathi", "DD Sahyadri", "Fakt Marathi", "Zee Talkies", "Zee Talkies HD", "Pravah Picture", "Pravah Picture HD", "Shemaroo Marathibana", "Zee Chitramandir", "Zee 24 Taas", "ABP Majha", "News18 Lokmat", "NDTV Marathi", "TV9 Marathi", "Saam TV", "Jai Maharashtra", "Lokshahi", "Pudhari News", "9X Jhakaas", "Maiboli", "Sangeet Marathi", "Dagdusheth Ganpati (Live)", "Vitthal Rukmini (Live)", "Tulja Bhavani (Live)", "Mahalaxmi Mumbai (Live)", "MKN Marathi", "News State Maharashtra-Goa"]
          
          # Keywords to keep
          allowed_keywords = ["tataplay", "runntv", "lg movies", "waves ott", "jiotv"]

          with open("raw_pool.m3u", "r", encoding="utf-8", errors="ignore") as f:
              content = f.read()

          blocks = re.split(r'(?=#EXTINF)', content)
          master_list = {}

          for block in blocks:
              block = block.strip()
              if not block or "#EXTM3U" in block: continue
              
              header = block.split('\n')[0]
              group_match = re.search(r'group-title="([^"]*)"', header, re.IGNORECASE)
              name_match = re.search(r',([^,]*)$', header)
              
              raw_group = group_match.group(1) if group_match else ""
              name = name_match.group(1).strip() if name_match else ""
              name_key = name.lower()

              if not any(k in raw_group.lower() for k in allowed_keywords) and "jiotv+" not in raw_group.lower():
                  continue

              # --- SMART CATEGORY CLEANER ---
              # This removes "JioTvðŸ“º", "JioTv+âž•", "TataplayðŸŽ­" and any symbols at the start
              # It looks for the part after the emoji or prefix
              new_group = raw_group
              # Pattern matches Prefix + Emoji/Symbol + Category Name
              clean_pattern = r'^(?:JioTv|Tataplay|RunnTV|Waves|LG).*?[ðŸ“ºâž•ðŸŽ­ðŸƒðŸŽ¬]\s*(.*)'
              match = re.match(clean_pattern, raw_group, re.IGNORECASE)
              if match:
                  new_group = match.group(1).strip()
              else:
                  # Fallback: remove common prefixes if emoji pattern doesn't match
                  new_group = re.sub(r'^(jiotv(\+)?|tataplay).*?(\||:|-)\s*', '', raw_group, flags=re.IGNORECASE)
              
              new_group = new_group.strip().capitalize() if new_group else "General"

              # --- SCORING SYSTEM ---
              # Base: TataPlay (20), Jio (10)
              score = 10
              if "tataplay" in raw_group.lower(): score = 20
              
              # CATCHUP PRIORITY: Huge bonus (+50) so Catchup ALWAYS wins over Source
              if any(x in header.lower() for x in ['catchup="default"', 'catchup-days=', 'catchup-source=']):
                  score += 50

              # Deduplication Logic
              if name_key not in master_list or score > master_list[name_key]["score"]:
                  updated_block = re.sub(r'group-title="[^"]*"', f'group-title="{new_group}"', block)
                  master_list[name_key] = {"score": score, "block": updated_block}

          marathi_out = []
          others_out = []

          for name_key, info in master_list.items():
              block = info["block"]
              if any(t.lower() == name_key for t in marathi_targets):
                  mod_block = re.sub(r'group-title="[^"]*"', 'group-title="Marathi"', block)
                  marathi_out.append(mod_block)
              else:
                  others_out.append(block)

          marathi_out.sort(key=lambda x: x.split(",")[-1].strip().lower())
          # Sort others by Category then Name
          others_out.sort(key=lambda x: (re.search(r'group-title="([^"]*)"', x).group(1) if re.search(r'group-title="([^"]*)"', x) else "", x.split(",")[-1]))

          with open("merged_playlist.m3u", "a", encoding="utf-8") as out:
              if marathi_out:
                  out.write("\n## --- MARATHI --- ##\n" + "\n".join(marathi_out) + "\n")
              if others_out:
                  out.write("\n## --- CHANNELS --- ##\n" + "\n".join(others_out) + "\n")
          EOF

      - name: Push Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          sed -i '/^$/d' merged_playlist.m3u
          git add merged_playlist.m3u
          git commit -m "Fixed emoji-category merging and set Catchup as top priority" || exit 0
          git push

name: Merge M3U Playlists
on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  merge-job:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout your repo
        uses: actions/checkout@v4

      - name: Fetch and Merge Playlists
        run: |
          # 1. Start with M3U Header and EPG
          echo '#EXTM3U x-tvg-url="https://avkb.short.gy/tsepg.xml.gz"' > merged_playlist.m3u
          
          # 2. Download and Clean sources (Remove existing group titles to prevent mixing)
          curl -s https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/jtv.m3u | sed 's/^#EXTM3U//g' >> temp_raw.m3u
          curl -s https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/z5.m3u | sed 's/^#EXTM3U//g' >> temp_raw.m3u
          
          # 3. Add JSON source
          curl -s https://raw.githubusercontent.com/DebugDyno/yo_events/4a8ac953d5db100864bd91afd12afda8f7e33f62/sony_livetv.json | \
          jq -r '.data[] | "#EXTINF:-1 tvg-logo=\"\(.image)\" group-title=\"\(.group)\", \(.name)\n\(.stream)"' >> temp_raw.m3u

          # 4. Extract ONLY Exact Marathi Channels
          echo "## --- MARATHI --- ##" >> merged_playlist.m3u
          
          # We use a strict pattern match to avoid Zee Punjabi, Sony WAH, etc.
          # The '$' ensures it matches the name specifically at the end of the line.
          grep -Ei ", Zee Marathi|, Star Pravah|, Colors Marathi|, Sony Marathi|, Zee Yuva|, Sun Marathi|, DD Sahyadri|, Fakt Marathi|, Zee Talkies|, Pravah Picture|, Shemaroo Marathibana|, Zee Chitramandir|, Zee 24 Taas|, ABP Majha|, News18 Lokmat|, NDTV Marathi|, TV9 Marathi|, Saam TV|, Jai Maharashtra|, Lokshahi|, Pudhari News|, 9X Jhakaas|, Maiboli|, Sangeet Marathi|, Dagdusheth|, Vitthal Rukmini|, Tulja Bhavani|, Mahalaxmi|, MKN Marathi|, News State" temp_raw.m3u -A 8 | grep -vE "^--$" > marathi_temp.m3u

          # 5. Force "Marathi" group title and fix logos
          sed -i 's/group-title="[^"]*"/group-title="Marathi"/g' marathi_temp.m3u
          
          # High Quality Logo Fixer (Ensuring exact matches)
          sed -i 's|tvg-logo="[^"]*"\(.*\)Zee Marathi|tvg-logo="https://raw.githubusercontent.com/pali94/Marathitv/main/logos/zeemarathi.png"\1Zee Marathi|g' marathi_temp.m3u
          sed -i 's|tvg-logo="[^"]*"\(.*\)Star Pravah|tvg-logo="https://raw.githubusercontent.com/pali94/Marathitv/main/logos/starpravah.png"\1Star Pravah|g' marathi_temp.m3u
          sed -i 's|tvg-logo="[^"]*"\(.*\)Colors Marathi|tvg-logo="https://raw.githubusercontent.com/pali94/Marathitv/main/logos/colorsmarathi.png"\1Colors Marathi|g' marathi_temp.m3u

          cat marathi_temp.m3u >> merged_playlist.m3u

          # 6. Add "Others" section
          echo "## --- OTHERS --- ##" >> merged_playlist.m3u
          cat temp_raw.m3u >> merged_playlist.m3u

      - name: Cleanup and Commit
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          # Final cleanup: Remove blank lines
          sed -i '/^$/d' merged_playlist.m3u
          rm -f temp_raw.m3u marathi_temp.m3u
          
          git add merged_playlist.m3u
          git commit -m "Fixed: Marathi category filtered for exact matches" || exit 0
          git push

